---
title: Differences from v2 to v3
---

This is a technical note on the differences between Witchcraft v2 and v3.

## Witchcraft v2 architecture

Up until Witchcraft v2, the architecture was composed of a background script, a content script and the popup window. These are the relevant parts of the manifest file:

```json title="manifest.json (excerpt)"
  "content_scripts": [{
    "all_frames": true,
    "run_at":     "document_start",
    "matches":    ["http://*/*", "https://*/*"],
    "js":         ["content-script.js"]
  }],
  "background": {
    "page": "background.html",
    "persistent": false
  },
  "content_security_policy": "script-src 'self'; object-src 'self'"
```

This is how it worked:

1. The content script was injected in every frame of every tab (the `content_scripts.matches` property)
2. at `document_start`, the content script sent a message to the background script passing `window.location` as argument:
    ```js title="content-script.js (excerpt)"
    chrome.runtime.sendMessage(location);
    ```
3. the background would listen for these messages (via `chrome.runtime.onMessage.addListener()`), receive the message and fetch all the scripts that could be applied to that URL
4. the background script would then send each loaded script as text to the content script at, using `chrome.tabs.sendMessage()`, targeting the specific tab and frame
5. the content script would then run the script like so:
    ```js title="content-script.js (excerpt, simplified version)"
    chrome.runtime.onMessage.addListener(scriptContents => {
        Function(scriptContents)();
    });
    ```
    *(CSS worked similarly, but instead of using `Function()`, it would create a `<style>` element and append it to the document's `<head>`)*

The background script would keep an in-memory cache of what scripts were loaded for which tab/frame, mainly used to show the counter in the extension icon and the list of scripts in the popup window.

## Problems with v2

The first problem appeared when Chrome changed behavior and started unloading extensions at its own will. Extensions that relied on caching data in memory would lose information and stop working - and that affected Witchcraft v2, which started showing erratic behavior. See more about this [here](https://developer.chrome.com/docs/extensions/develop/migrate/to-service-workers?utm_source=chatgpt.com#persist-states).

The second (and most important) problem was that Google [announced](https://developer.chrome.com/docs/extensions/develop/migrate/mv2-deprecation-timeline) that Manifest v2 was being deprecated and that all extensions should migrate to Manifest v3. Migrating to Manifest v3 was not a simple task, because it introduced a few breaking changes that directly affected Witchcraft.

